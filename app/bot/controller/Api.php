<?php
/**
 * Created by PhpStorm.
 * Script Name: Onmessage.php
 * Create: 12/25/21 9:43 PM
 * Description:
 * Author: fudaoji<fdj@kuryun.cn>
 */

namespace app\bot\controller;

use app\constants\Bot as BotConst;
use app\common\controller\BaseCtl;
use ky\Helper;
use ky\Logger;

class Api extends BaseCtl
{
    protected $driver;
    public function initialize()
    {
        parent::initialize(); // TODO: Change the autogenerated stub
        $this->driver = strtolower(input('driver', BotConst::PROTOCOL_MY));
        if(request()->isPost() && isset(BotConst::protocols()[$this->driver])) {
            set_time_limit(0);
            Helper::$ajax = $this->getAjax();
            if($this->driver == 'xy'){
                Logger::error(Helper::$ajax);
                exit(0);
            }
        }else{
            Logger::error('Request invalid!' . request()->method());
            exit(0);
        }
    }

    /**
     * 入口
     * tip:
     * 1.机器人对某个好友的私聊不会有回调
     * 2.机器人在群里发的情况下，from_wxid和from_group 都为空
     * Author: fudaoji<fdj@kuryun.cn>
     */
    public function index(){
        $options = [
            'ajax_data' => Helper::$ajax,
            'driver' => $this->driver,
        ];
        $handler = new \app\bot\handler\Handler();
        $handler->serve($options);
    }
}