<?php
/**
 * Created by PhpStorm.
 * Script Name: Botbase.php
 * Create: 2021/12/21 12:37
 * Description:
 * Author: fudaoji<fdj@kuryun.cn>
 */

namespace app\admin\controller;


use app\constants\Bot;

class Botbase extends Bbase
{
    protected $botList = [];
    protected $bot;

    public function initialize()
    {
        parent::initialize(); // TODO: Change the autogenerated stub
        $this->bot = model('admin/bot')->getOneByMap(['admin_id' => $this->adminInfo['id'], 'is_current' => 1]);
        if(empty($this->bot)){
            $this->error('请选择机器人操作', url('bot/index'));
        }
        $this->botList = $this->getBots();
        $this->assign['bot_info'] = $this->bot;
        $this->assign['bot_list'] = $this->botList;
    }

    public function getGroups($where = []){
        $where = array_merge($where, ['uin' => $this->bot['uin'], 'type' => Bot::GROUP]);
        return model('admin/botMember')->getField('wxid,nickname', $where, true);
    }

    public function getMembers($where = []){
        $where = array_merge($where, ['uin' => $this->bot['uin']]);
        return model('admin/botMember')->getField('wxid,nickname', $where, true);
    }

    public function getBots($where = []){
        $where = array_merge($where, ['status' => 1]);
        return model('admin/bot')->getField(['id','title'], $where);
    }
}